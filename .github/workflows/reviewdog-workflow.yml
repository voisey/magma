# Copyright 2022 The Magma Authors.
#
# This source code is licensed under the BSD-style license found in the
# LICENSE file in the root directory of this source tree.
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

# owner: any
# purpose: Linting various components
# remediation: -

name: PR Lint Reviewdog
on:
  pull_request:
    types:
      - opened
      - reopened
      - synchronize

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number}}
  cancel-in-progress: true
# Applies on all review jobs below
# See Reviewdog doc provided at https://github.com/reviewdog/reviewdog
# github-pr-check: Adds lint as annotations in the PR that can be toggled by pressing 'a'
# github-pr-review: Adds lint as GitHub comments
jobs:
  files_changed:
    runs-on: ubuntu-20.04
    outputs:
      changed_cpp: ${{ steps.changes.outputs.cpp }}
      changed_javascript: ${{ steps.changes.outputs.javascript }}
      changed_python: ${{ steps.changes.outputs.python }}
      changed_terraform: ${{ steps.changes.outputs.terraform }}
    steps:
      # Need to get git on push event
      - uses: actions/checkout@93ea575cb5d8a053eaa0ac8fa3b40d7e05a33cc8 # pin@v3.1.0
        if: github.event_name == 'push'
      - uses: dorny/paths-filter@4512585405083f25c027a35db413c2b3b9006d50 # pin@v2.11.1
        id: changes
        with:
          filters: |
            cpp:
              - ["lte/gateway/c/**", "orc8r/gateway/c/**"]
            javascript:
              - ["nms/**", "**/*.js"]
            python:
              - ["**/*.py"]
            terraform:
              - ["**/*.tf"]

  mypy:
    needs: files_changed
    if: ${{ needs.files_changed.outputs.changed_python == 'true' }}
    name: mypy
    runs-on: ubuntu-20.04
    steps:
      - name: Check out code.
        uses: actions/checkout@93ea575cb5d8a053eaa0ac8fa3b40d7e05a33cc8 # pin@v3.1.0
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          repository: ${{ github.event.pull_request.head.repo.full_name }}
          fetch-depth: 0
      - name: Run mypy with reviewdog
        uses: tsuyoshicho/action-mypy@176f65a2ad781202baffaf870e5715d768d799a8 # pin@v3.9.2
        with:
          github_token: ${{ secrets.github_token }}
          filter_mode: file
          reporter: github-pr-review
          fail_on_error: true
